# RFC  - 2021-11-XX - Ingest APM stats in `datadog-agent` source

Datadog traces support in `datadog-agent` source was initially documented in this [RFC][trace-support-pr]. However the Datadog `trace-agent` submit more data that juste traces. It also send statistics ("APM Stats") about running time of each instrumented resource (i.e. a given piece of code) that are aggregated over time (based on 100% of the traces received). Those APM stats are very important as they can highlight code hot spots and ease aggregation. Also as an integral part of the Datadog APM product, APM stats should be handled by Vector.

[trace-support-pr]: https://github.com/vectordotdev/vector/pull/9634

## Context

Traces are new in Vector, initial support is focusing on traces coming from the Datadog Agent, the [RFC][trace-support-pr] discussing about traces describes how those traces will be handled in Vector and highlighted the need to support APM stats.

APM stats are encoded using protobuf, the current schema is available in the [datadog-agent][apm-stats-proto] repository. APM stats may be computed by the tracing lib in some cases or most of the time by the trace agent, but once they are emitted by the `trace-agent` there is no difference except a [boolean value][client-side-marker] that indicates where it was computed.

Those stats are computed by a componen named [concentrator] in the trace-agent. There is a [dedicated path][client-stats-aggregator] for APM stats that comes directly from tracing libraries. But ultimately they flow through datadog with the same [sending code][stats-writer].

If we details a bit the actual content of a stats payload, it is a list of [`ClientGroupedStats`][client-grouped-stats-proto]:
```
	string service = 1;
	string name = 2;
	string resource = 3;
	uint32 HTTP_status_code = 4;
	string type = 5;
	string DB_type = 6; // db_type might be used in the future to help in the obfuscation step
	uint64 hits = 7; // count of all spans aggregated in the groupedstats
	uint64 errors = 8; // count of error spans aggregated in the groupedstats
	uint64 duration = 9; // total duration in nanoseconds of spans aggregated in the bucket
	bytes okSummary = 10; // ddsketch summary of ok spans latencies encoded in protobuf
	bytes errorSummary = 11; // ddsketch summary of error spans latencies encoded in protobuf
	bool synthetics = 12; // set to true on spans generated by synthetics traffic
	uint64 topLevelHits = 13; // count of top level spans aggregated in the groupedstats
```

So it is basically a group of various metrics that can be represented in Vector (Sketches are support since this [PR][sketch-pr]). In the proto definition sketches are stored as unstructured bytes slices, but those [fields][call-to-toproto] are filled with a [protobuf encoded ddsketch][ddsktech-proto]. Given the sketch implementation in Vector is also [heavily based on ddsketch][vector-sketch]  this should not cause any significant accuracy loss (TBC).

[apm-stats-proto]: https://github.com/DataDog/datadog-agent/blob/dc2f202/pkg/trace/pb/stats.proto
[client-side-marker]: https://github.com/DataDog/datadog-agent/blob/dc2f202/pkg/trace/pb/stats.proto#L15
[concentrator]: https://github.com/DataDog/datadog-agent/blob/dc2f202/pkg/trace/stats/concentrator.go
[client-stats-aggregator]: https://github.com/DataDog/datadog-agent/blob/dc2f202/pkg/trace/stats/client_stats_aggregator.go#L25-L45
[stats-writer]: https://github.com/DataDog/datadog-agent/blob/dc2f202/pkg/trace/writer/stats.go
[client-grouped-stats-proto]: https://github.com/DataDog/datadog-agent/blob/dc2f202/pkg/trace/pb/stats.proto#L55-L70
[sketch-pr]: https://github.com/vectordotdev/vector/pull/9178
[call-to-toproto]: https://github.com/DataDog/datadog-agent/blob/dc2f202/pkg/trace/stats/statsraw.go#L53-L62
[ddsktech-proto]: https://github.com/DataDog/sketches-go/blob/0829b5a6a3c9627d1faee6c690611067ee110e38/ddsketch/pb/ddsketch.proto
[vector-sketch]: https://github.com/vectordotdev/vector/blob/4db23b3/lib/vector-core/src/metrics/ddsketch.rs#L202-L213

## Cross cutting concerns

N/A

## Scope

### In scope

- Decode APM request (protobuf) received from the trace agent
- Convert those into a Vector internal representation
- Enable the passthrough use case (trace-agent -> Vector -> Datadog) in a lossless fashion

### Out of scope

- Compute APM stats in Vector
- Any support for other kind of traces

## Pain

- Vector has no trace support

## Proposal

### User Experience

- The `datadog-agent` source will accept APM stats (along with traces), and emit Vector metrics with some (TBD) metadata
- The `datadog-trace` sink will accept metrics (sketches) and do the opposite conversion, pending that expected tags will be there

### Implementation

- Import all APM stats as standard vector metrics in the `datadog-agent` source with all possible metadata to allow the pass-through scenario.
- In the upcoming `datadog-trace` implement a sending loop that aggregate metrics and rebuild relavant payload based on the same aggregation key to build comptabible payloads:
   - TODO: add details about aggregation key
   - TODO: add details about the flushing loop

## Rationale

- We should Keep valuable metrics relevant to end-user
- Dropping APM stats would cause current user to loose some insight on execution time.

## Drawbacks

- Why should we not do this?
- What kind on ongoing burden does this place on the team?

## Prior Art

- Metrics link

## Alternatives

- Disable sampling on the `trace-agent` side and:
  - either completely drop APM stats, not really an option as it would lead to user experience degradation
  - compute APM stats in the `datadog-trace` sink, could work but to match the accuracy of current APM stats, Vector
    would have to receive 100% of traces, which may not always be possible



## Outstanding Questions

- List any remaining questions.
- Use this to resolve ambiguity and collaborate with your team during the RFC process.
- *These must be resolved before the RFC can be merged.*

## Plan Of Attack

Incremental steps to execute this change. These will be converted to issues after the RFC is approved:

- [ ] Submit a PR with spike-level code _roughly_ demonstrating the change.
- [ ] Incremental change #1
- [ ] Incremental change #2
- [ ] ...

Note: This can be filled out during the review process.

## Future Improvements

- Compute APM stats in the `datadog-traces` sink for any trace format

